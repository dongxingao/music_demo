<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord-Transformer Music</title>
    <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #fff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .authors {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .authors a {
            color: #0066cc;
            text-decoration: none;
        }

        .authors a:hover {
            text-decoration: underline;
        }

        .links {
            margin-bottom: 30px;
        }

        .links a {
            color: #0066cc;
            text-decoration: none;
            margin-right: 15px;
        }

        .links a:hover {
            text-decoration: underline;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        h2 {
            font-size: 20px;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
        }

        h3 {
            font-size: 16px;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .demo-section {
            margin-bottom: 40px;
        }

        .demo-item {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .demo-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .demo-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .demo-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-button {
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: #333;
        }

        .play-button:hover {
            background-color: #e8e8e8;
        }

        .play-button:active {
            background-color: #ddd;
        }

        .play-button.playing {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .play-button:disabled {
            background-color: #f8f8f8;
            color: #999;
            cursor: not-allowed;
        }

        .demo-info {
            font-size: 12px;
            color: #777;
        }

        .category-header {
            background-color: #f0f0f0;
            padding: 10px 15px;
            margin: 25px 0 15px 0;
            border-left: 4px solid #0066cc;
            font-weight: 600;
            font-size: 14px;
        }

        ul {
            list-style-type: disc;
            margin-left: 30px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 5px;
        }

        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }

        .footer a {
            color: #0066cc;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        /* Custom player style for all sections */
        .music-section midi-player {
          display: block;
          width: inherit;
          margin: 4px;
          margin-bottom: 0;
        }

        .music-section midi-player::part(control-panel) {
          background: #e9e9e9;
          border: 2px solid gray;
          border-radius: 10px 10px 0 0;
        }

        .music-section midi-player::part(play-button) {
          color: #353;
          border: 2px solid currentColor;
          background-color: #b6c9cf;
          border-radius: 20px;
          transition: all 0.2s;
        }

        .music-section midi-player::part(play-button):hover {
          color: #f0f0f0;
          background-color: #5f5;
          border-radius: 10px;
        }

        .music-section midi-player::part(time) {
          font-family: monospace;
        }

        /* Custom visualizer style for all sections */
        .music-section midi-visualizer .piano-roll-visualizer {
          background: #f4faff;
          border: 2px solid gray;
          border-top: none;
          border-radius: 0 0 10px 10px;
          margin: 4px;
          margin-top: 0;
          overflow: auto;
        }

        .music-section midi-visualizer svg rect.note {
          opacity: 0.6;
          stroke-width: 2;
        }

        .music-section midi-visualizer svg rect.note {
          fill: #537790;
        }
        
        .music-section midi-visualizer svg rect.note.active {
          opacity: 0.9;
          stroke: #000;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Chord-Transformer Music Generation</h1>
        
        <div class="authors">
        </div>

        <h2>Abstract</h2>
        <p>Transformer-based music generation models are increasingly becoming a vital approach for music composition and editing. Current music generation models face a main challenge in lacking effective structural control mechanisms, making it difficult to maintain harmonic coherence and structural integrity in generated music. This paper presents the Chord-Transformer architecture, which uses chord progression sequences as high-level semantic features to guide the music generation process. Our method first applies an energy-based dynamic programming algorithm to extract chord progression sequences from given chord sequences, then uses these as structural constraints combined with Transformer architecture to achieve autoregressive generation from chords to music. To enhance the model's ability to capture musical structure, we design a chord-aligned positional encoding scheme and introduce a fusion module that combines cross-attention for chord progression sequences with self-attention for music sequences. This mechanism strengthens collaborative modeling of local and global chord contexts, effectively improving harmonic consistency and structural integrity of generated music. Experimental results show that compared to baseline models, our proposed Chord-Transformer achieves significant improvements in key metrics including scale consistency, polyphonic quality, and user preference scores.
</p>

        <h2>Demo</h2>
        <p>Here are some comparative examples to demonstrate that our model is closer to real music in terms of music theory and auditory perception.</p>

        <section id="chord-pop909" class="music-section">
        <h2 class="category-header"> Chord-Transformer(POP909)</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/pop909_chord.mid"
          sound-font visualizer="#chord-pop909 midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/pop909_chord.mid">
        </midi-visualizer>
        </section>
      
        <section id="chord-lmd" class="music-section">
        <h2 class="category-header"> Chord-Transformer(LMD)</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/chord_LMD.mid"
          sound-font visualizer="#chord-lmd midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/chord_LMD.mid">
        </midi-visualizer>
        </section>

        <p>Our Chord-Transformer demonstrates excellent overall performance, with various metrics approaching that of real music. Notably, the model excels in structural consistency and scale accuracy, while maintaining good melodic coherence and harmonic complexity. This proves the model's strong generalization capability.</p>
 
        <section id="figaro-section" class="music-section">
        <h2 class="category-header"> Figaro</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/figaro.mid"
          sound-font visualizer="#figaro-section midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/figaro.mid">
        </midi-visualizer>
        </section>
        <p>Although Figaro shows some strength in melodic complexity, its weaknesses are quite apparent. It has a relatively high blank ratio, poor scale accuracy, and limited harmonic depth. Overall, its stability leaves much to be desired.</p>

        <section id="music-transformer-section" class="music-section">
        <h2 class="category-header"> Music-Transformer</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/musictransformer034.mid"
          sound-font visualizer="#music-transformer-section midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/musictransformer034.mid">
        </midi-visualizer>
        </section>
        <p>As an early music generation model, Music Transformer has limited baseline performance and exhibits relatively conservative results across various metrics. It lacks melodic richness, has suboptimal structural consistency, and its harmonic layers are relatively simple. Overall, the generation quality needs improvement.</p>

        <section id="theme-transformer-section" class="music-section">
        <h2 class="category-header"> Theme-Transformer</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/themetransformer874_gen.mid"
          sound-font visualizer="#theme-transformer-section midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/themetransformer874_gen.mid">
        </midi-visualizer>
        </section>
        <p>Theme Transformer performs decently across most metrics, showing improvements over Music Transformer. Its structural consistency is acceptable, but it lacks innovation in melody. The harmonic complexity is average, with no groundbreaking advancements.</p>

        <div class="category-header">Ground-Truth</div>

        <section id="pop909-ground-truth" class="music-section">
        <h2>POP909</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/pop909_022.mid"
          sound-font visualizer="#pop909-ground-truth midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/pop909_022.mid">
        </midi-visualizer>
        </section>

        <section id="lmd-ground-truth" class="music-section">
        <h2>LMD</h2>
        <midi-player
          src="https://dongxingao.github.io/music_demo/lmddatabase.mid"
          sound-font visualizer="#lmd-ground-truth midi-visualizer">
        </midi-player>
        <midi-visualizer
          type="piano-roll"
          src="https://dongxingao.github.io/music_demo/lmddatabase.mid">
        </midi-visualizer>
        </section>
      
        <p>Our Chord-Transformer achieves a balanced development of both metrics and auditory perception while maintaining high-quality music generation, offering a clear advantage over other models.</p>

        <div class="footer">
            Thanks <a href="https://cifkao.github.io/html-midi-player/">html-midi-player</a> for the excellent MIDI visualization.
        </div>
    </div>

    <script>
        // 全局状态
        let currentPlaying = null;
        let currentAudio = null;

        // 模拟数据
        const demoData = {
            main: [
                {
                    id: 'main-1',
                    title: 'Whole-song generation example (40 bars, Ab major)',
                    description: 'Complete song with melody and piano accompaniment, phrase structure: i4A4A4B8b4A4B8o4',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                }
            ],
            reducedLeadsheet: [
                {
                    id: 'rls-1',
                    title: 'Reduced Lead Sheet variation 1',
                    description: '8-measure verse in Eb major',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                },
                {
                    id: 'rls-2',
                    title: 'Reduced Lead Sheet variation 2',
                    description: '8-measure verse in Eb major with external chord control',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                }
            ],
            leadsheet: [
                {
                    id: 'ls-1',
                    title: 'Lead Sheet variation 1',
                    description: 'Generated with specified reduced lead sheet',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                },
                {
                    id: 'ls-2',
                    title: 'Lead Sheet variation 2',
                    description: 'With dense rhythmic pattern control',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                }
            ],
            accompaniment: [
                {
                    id: 'acc-1',
                    title: 'Accompaniment variation 1',
                    description: 'Piano accompaniment with lead melody',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                },
                {
                    id: 'acc-2',
                    title: 'Accompaniment with Alberti bass texture',
                    description: 'Left hand quarter notes, right hand Alberti pattern',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
                }
            ]
        };

        function createDemoItem(demo) {
            return `
                <div class="demo-item">
                    <div class="demo-title">${demo.title}</div>
                    <div class="demo-description">${demo.description}</div>
                    <div class="demo-controls">
                        <button class="play-button" onclick="handlePlay('${demo.id}')" id="btn-${demo.id}">
                            Play
                        </button>
                        <span class="demo-info" id="info-${demo.id}"></span>
                    </div>
                </div>
            `;
        }

        function loadDemos() {
            // 如果存在这些容器，则加载demos
            const containers = ['demo-container', 'reduced-leadsheet-demos', 'leadsheet-demos', 'accompaniment-demos', 'more-examples-demos'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    // 根据容器ID加载对应的数据
                    let data = [];
                    if (containerId === 'demo-container') data = demoData.main;
                    else if (containerId === 'reduced-leadsheet-demos') data = demoData.reducedLeadsheet;
                    else if (containerId === 'leadsheet-demos') data = demoData.leadsheet;
                    else if (containerId === 'accompaniment-demos') data = demoData.accompaniment;
                    else if (containerId === 'more-examples-demos') data = demoData.moreExamples;
                    
                    container.innerHTML = data.map(createDemoItem).join('');
                }
            });

            // 隐藏加载指示器
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }

        function handlePlay(demoId) {
            const btn = document.getElementById(`btn-${demoId}`);
            const info = document.getElementById(`info-${demoId}`);

            if (currentPlaying === demoId) {
                // 暂停当前播放
                if (currentAudio) {
                    currentAudio.pause();
                    stopPlaying();
                }
                return;
            }

            // 停止之前的播放
            if (currentAudio) {
                currentAudio.pause();
                stopPlaying();
            }

            // 获取demo数据
            let demo = null;
            for (const category of Object.values(demoData)) {
                demo = category.find(d => d.id === demoId);
                if (demo) break;
            }

            if (!demo) return;

            try {
                // 设置加载状态
                btn.disabled = true;
                btn.textContent = 'Loading...';
                btn.className = 'play-button';

                const audio = new Audio(demo.url);

                audio.addEventListener('canplay', () => {
                    currentPlaying = demoId;
                    currentAudio = audio;
                    
                    btn.disabled = false;
                    btn.textContent = 'Stop';
                    btn.className = 'play-button playing';
                    info.textContent = 'Playing...';
                    
                    audio.play();
                });

                audio.addEventListener('ended', () => {
                    stopPlaying();
                });

                audio.addEventListener('error', () => {
                    btn.disabled = false;
                    btn.textContent = 'Error';
                    btn.className = 'play-button';
                    info.textContent = 'Failed to load audio';
                    
                    setTimeout(() => {
                        btn.textContent = 'Play';
                        info.textContent = '';
                    }, 2000);
                });

            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'Error';
                info.textContent = 'Playback failed';
            }
        }

        function stopPlaying() {
            if (currentPlaying) {
                const btn = document.getElementById(`btn-${currentPlaying}`);
                const info = document.getElementById(`info-${currentPlaying}`);
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Play';
                    btn.className = 'play-button';
                }
                
                if (info) {
                    info.textContent = '';
                }
            }
            
            currentPlaying = null;
            currentAudio = null;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 延迟加载demo数据（如果存在相关容器）
            setTimeout(loadDemos, 800);
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            if (currentAudio) {
                currentAudio.pause();
            }
        });
    </script>
</body>
</html>
